<!DOCTYPE html>
<html lang="en">
    <head>
        <title>RoomLayout</title>
        <meta charset="utf-8" />
        <meta
            name="generator"
            content="Three.js Editor"
        />
        <meta
            name="viewport"
            content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0"
        />
        <style>
            body {
            	font-family: sans-serif;
            	font-size: 11px;
            	background-color: #000;
            	margin: 0px;
            }
            canvas {
            	display: block;
            }
        </style>
    </head>
    <body ontouchstart="">
        <script src="src/Utility.js" type="text/javascript"></script>
        <script src="src/Delegate.js" type="text/javascript"></script>
        <script src="src/Input.js" type="text/javascript"></script>
        <script src="js/app.js" type="text/javascript"></script>
        <script src="js/three.module.js" type="text/javascript"></script>
        <script src="src/Controller.js" type="text/javascript"></script>
        <script src="src/FirstPersonControls.js" type="text/javascript"></script>
        <script type="module">

            var loader = new FileLoader();
			var player = new APP.Player();

            loader.load( 'app.json', function ( text ) {

            	player.load( JSON.parse( text ) );
            	player.setSize( window.innerWidth, window.innerHeight );
            	player.play();
            	document.body.appendChild( player.dom );
                player.dom.firstChild.id = "cvsDisplay";

            	window.addEventListener( 'resize', function () {

            		player.setSize( window.innerWidth, window.innerHeight );

            	} );
                
                loader.load( 'scene.json', function ( text ) {
                    var objloader = new ObjectLoader();
                    player.setScene(objloader.parse( JSON.parse(  text) ));
            
                    var input = new Input();
                    window.input = input;
                    window.onkeydown=input.processKeyDown.bind(input);
                    window.onkeyup=input.processKeyUp.bind(input);
                    window.onmousedown=input.processMouseDown.bind(input);
                    window.onmousemove=input.processMouseMove.bind(input);
                    window.onmouseup=input.processMouseUp.bind(input);

                    // var controller = new Controller(player.camera, player.scene);
                    var object = player.scene.children[0];
                    var controller = new FirstPersonControls(player.camera, player.dom);
                    window.controller = controller;
                    input.key.down.add(controller._onKeyDown);
                    input.key.up.add(controller._onKeyUp);
                    input.mouse.down.add(controller._onPointerDown);
                    input.mouse.move.add(controller._onPointerMove);
                    input.mouse.up.add(controller._onPointerUp);
                    // input.key.down.add(controller.processInput.bind(controller));
                    // input.mouse.down.add(controller.processMouseDown.bind(controller));
                    // input.mouse.move.add(controller.processMouseMove.bind(controller));
                    // input.mouse.up.add(controller.processMouseUp.bind(controller));
                    window.looping = false;
                    var loop;
                    var lastTime = 0;
                    loop = (now)=>{
                        if (!(lastTime > 0)){
                            lastTime = now;
                        }
                        if (!(now > 0)){
                            now = lastTime;
                        }
                        var delta = now - lastTime;
                        if (!(delta > 0)){
                            delta = 0;
                        }
                        delta /= 1000;
                        controller.update(delta);
                        if (window.looping){
                        window.requestAnimationFrame(loop);
                        }
                        lastTime = now;
                    }
                    window.loop = loop;
                    
                    // input.key.down.add(controller._update);
                    input.key.down.add((s,e)=>{
                        switch(e.keyCode){
                            //esc
                            case 27: window.looping = false; break;
                            //enter
                            case 13: window.looping = true; loop(); break;
                        }
                    });
                    // loop();

                });
            } );
        </script>        
    </body>
</html>
